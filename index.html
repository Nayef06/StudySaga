<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Study Saga</title>
<style>
  :root{
    --bg:#0b1020; --bg2:#111735; --panel:#151b3d; --text:#e9edf7; --muted:#a9b2cf;
    --accent:#75d6ff; --accent2:#8ef0c9; --good:#5ee38a; --bad:#ff6b6b; --warn:#ffd166;
    --btn:#1e2655; --btnHover:#273074; --card:#0f1430; --border:#2a356b;
    --shadow:0 6px 18px rgba(0,0,0,.35);
  }
  [data-theme="light"]{
    --bg:#f7f8fb; --bg2:#ffffff; --panel:#ffffff; --text:#1b2238; --muted:#5a6383;
    --accent:#0066ff; --accent2:#00a87a; --good:#0e9b5c; --bad:#d22828; --warn:#b07a00;
    --btn:#e9eefc; --btnHover:#dfe6fb; --card:#f4f6ff; --border:#e4e7f5; --shadow:none;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Arial;
    background:linear-gradient(180deg,var(--bg) 0%,var(--bg2) 100%);
    color:var(--text);
  }
  header{
    position:sticky; top:0; z-index:10; backdrop-filter:saturate(1.2) blur(8px);
    background:linear-gradient(180deg,rgba(0,0,0,.35),rgba(0,0,0,0));
    padding:12px 16px; border-bottom:1px solid var(--border);
  }
  .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
  .title{font-weight:700; letter-spacing:.2px}
  .pill{padding:6px 10px; border:1px solid var(--border); border-radius:10px; background:var(--card); font-weight:600}
  .pill small{display:block; font-size:11px; color:var(--muted); font-weight:500}
  .pill strong{font-size:14px}
  .kps{color:var(--accent)}
  .caps{color:var(--accent2)}
  .combo{color:var(--warn)}
  .container{max-width:1200px; margin:0 auto; padding:16px}
  .grid{display:grid; grid-template-columns: 1fr 1fr; gap:16px}
  @media (max-width: 980px){ .grid{grid-template-columns: 1fr} }

  .panel{
    background:var(--panel); border:1px solid var(--border); border-radius:14px; box-shadow:var(--shadow);
    padding:14px; min-height:120px;
  }
  .panel h2{margin:0 0 10px 0; font-size:18px}
  .panel h3{margin:10px 0 8px 0; font-size:16px}
  .muted{color:var(--muted)}
  .tag{display:inline-block; padding:4px 8px; border-radius:8px; border:1px solid var(--border); background:var(--card); font-size:12px}
  .sep{height:1px; background:var(--border); margin:12px 0}
  .stack{display:flex; gap:8px; flex-wrap:wrap; align-items:center}

  /* ===== Redesigned clicker (Study Orb) ===== */
  .clickerArea{display:grid; place-items:center; gap:10px}
  .studyOrb{
    --size: 240px;
    width:var(--size); height:var(--size); border-radius:50%;
    position:relative; border:0; cursor:pointer; background:transparent;
    outline:none; user-select:none;
  }
  .studyOrb:active{transform:translateY(1px)}
  .studyOrb .ring{
    position:absolute; inset:-8px; border-radius:50%;
    background:
      conic-gradient(from 0deg at 50% 50%, rgba(117,214,255,.9), rgba(117,214,255,.2), rgba(117,214,255,.9));
    -webkit-mask: radial-gradient(circle at center, transparent 64%, #000 66%);
            mask: radial-gradient(circle at center, transparent 64%, #000 66%);
    animation: spin 7s linear infinite;
    filter: drop-shadow(0 0 12px rgba(117,214,255,.35));
  }
  @keyframes spin { to { transform: rotate(360deg) } }
  .studyOrb .inner{
    position:absolute; inset:0; border-radius:50%;
    background: radial-gradient(120% 100% at 70% 20%, rgba(117,214,255,.25), transparent 60%), var(--card);
    display:grid; place-items:center;
    border:1px solid var(--border);
    box-shadow: inset 0 12px 28px rgba(255,255,255,.04), 0 10px 22px rgba(0,0,0,.35);
  }
  .studyOrb .inner::after{
    content:""; position:absolute; inset:10%; border-radius:50%;
    background: radial-gradient(60% 50% at 40% 35%, rgba(255,255,255,.18), transparent 70%);
  }
  .studyOrb .emoji{
    font-size:64px; filter: drop-shadow(0 6px 12px rgba(0,0,0,.35));
    transform: translateY(-4px);
  }
  .studyOrb .clickmeta{
    position:absolute; bottom:14px; font-size:12px; color:var(--muted);
    background:rgba(0,0,0,.25); padding:4px 8px; border-radius:10px; border:1px solid var(--border);
  }
  .subtext{font-size:13px; color:var(--muted); text-align:center}

  /* ===== Progress to next Cap ===== */
  .progWrap{width:min(560px,100%); margin:6px auto 0 auto}
  .progLabel{font-size:12px; color:var(--muted); margin-bottom:6px}
  .progress{height:10px; border-radius:10px; background:rgba(255,255,255,.06); border:1px solid var(--border); overflow:hidden}
  .bar{height:100%; width:0%; background:linear-gradient(90deg, var(--accent), var(--accent2))}
  .progMeta{display:flex; justify-content:space-between; font-size:12px; color:var(--muted); margin-top:6px}

  /* ===== Campus Scene on main page ===== */
  .scene{display:flex; flex-wrap:wrap; gap:10px; margin-top:10px; justify-content:center}
  .tile{
    position:relative; width:62px; height:62px; border-radius:12px;
    border:1px solid var(--border); background:radial-gradient(100% 100% at 70% 20%, rgba(117,214,255,.10), transparent 55%), var(--card);
    display:grid; place-items:center; box-shadow:var(--shadow);
    animation: bob 3s ease-in-out infinite alternate;
  }
  .tile .ic{font-size:28px}
  .badge{
    position:absolute; top:-6px; right:-6px; font-size:11px; font-weight:800;
    background:var(--accent2); color:#06321e; padding:2px 6px; border-radius:999px; border:1px solid var(--border);
    box-shadow:0 2px 6px rgba(0,0,0,.25);
  }
  @keyframes bob{ from{transform:translateY(0)} to{transform:translateY(-6px)} }

  button, select, input[type="text"], textarea{
    background:var(--btn); color:var(--text); border:1px solid var(--border); border-radius:10px;
    padding:8px 10px; font-size:14px; transition:background .15s ease, opacity .2s ease, transform .02s ease;
  }
  button:hover{background:var(--btnHover)}
  button:disabled{opacity:.5; cursor:not-allowed}

  .bigbutton{ /* legacy class kept for layout harmony elsewhere */ }

  .shopitem{
    display:grid; grid-template-columns:60px 1fr auto; gap:12px; align-items:center;
    padding:10px; border:1px solid var(--border); border-radius:12px; background:var(--card); margin-bottom:8px;
  }
  .shopitem h4{margin:0; font-size:15px}
  .shopitem .desc{font-size:12px; color:var(--muted)}
  .price{font-weight:700}
  .afford{color:var(--good)}
  .cant{color:var(--bad)}
  .icon{font-size:30px; text-align:center}
  .upgradelist, .achlist{display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:10px}
  .card{
    background:var(--card); border:1px solid var(--border); border-radius:12px; padding:10px; min-height:80px;
  }
  .card h4{margin:0 0 6px 0; font-size:15px}
  .card .meta{font-size:12px; color:var(--muted)}
  .tabs{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px}
  .tabs button{padding:8px 12px; border-radius:12px; font-weight:700}
  .tabs button.active{outline:2px solid var(--accent)}
  .hidden{display:none}
  .toast{
    position:fixed; bottom:18px; right:18px; background:var(--panel); border:1px solid var(--border);
    padding:12px 14px; border-radius:12px; box-shadow:var(--shadow); z-index:200; max-width:320px
  }
  .event{
    padding:10px; border-radius:10px; border:1px dashed var(--warn); background:rgba(255,209,102,.08);
    display:none; margin-top:10px;
  }
  .event.show{display:block}
  .inline-num{font-variant-numeric:tabular-nums}
  .small{font-size:12px}
  .right{margin-left:auto}
  .footer{margin-top:12px; text-align:center; color:var(--muted); font-size:12px}
  .danger{background:rgba(255,107,107,.2)}
  .good{background:rgba(94,227,138,.12)}
  .warn{background:rgba(255,209,102,.15)}
</style>
</head>
<body data-theme="dark">
  <header>
    <div class="row">
      <div class="title">🎓 <strong>Study Saga</strong> — idle/clicker</div>
      <div class="pill"><small>Knowledge</small><strong class="inline-num" id="knowledge">0</strong></div>
      <div class="pill"><small>Per second</small><strong class="inline-num kps" id="kps">0</strong></div>
      <div class="pill"><small>Caps (unspent)</small><strong class="inline-num caps" id="caps">0</strong></div>
      <div class="pill"><small>Combo</small><strong class="inline-num combo" id="combo">x1.00</strong></div>
      <div class="right stack">
        <button id="toggleTheme" title="Toggle light/dark">🌓 Theme</button>
        <button id="saveNow" title="Save now">💾 Save</button>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="tabs">
      <button data-tab="main" class="active">Main</button>
      <button data-tab="shop">Shop</button>
      <button data-tab="upgrades">Upgrades</button>
      <button data-tab="prestige">Prestige</button>
      <button data-tab="capshop">Cap Shop</button>
      <button data-tab="achievements">Achievements</button>
      <button data-tab="stats">Stats</button>
      <button data-tab="settings">Settings</button>
      <button data-tab="help">Help</button>
    </div>

    <!-- ===== MAIN ===== -->
    <section id="tab-main" class="panel">
      <h2>Study</h2>
      <div class="clickerArea">
        <button id="clicker" class="studyOrb" title="Click to study">
          <div class="ring"></div>
          <div class="inner">
            <div class="emoji">📘</div>
            <div class="clickmeta">+<span id="clickPreview">0</span> / click</div>
          </div>
        </button>
        <div class="subtext">Gain Knowledge by clicking — combos increase click value</div>

        <!-- Progress to next Cap -->
        <div class="progWrap">
          <div class="progLabel">Progress to next Cap</div>
          <div class="progress"><div id="capProgBar" class="bar"></div></div>
          <div class="progMeta">
            <div id="capProgLeft">Next at –</div>
            <div id="capProgGain">Caps on Graduate now: 0</div>
          </div>
        </div>
      </div>

      <h3>Your Campus</h3>
      <div id="campusScene" class="scene"></div>

      <div class="event" id="eventArea">
        <strong>📣 Pop Quiz!</strong> Click this banner within <span id="eventTime">0</span>s for a burst of Knowledge and a temporary Focus boost!
        <button id="eventBtn" class="warn" style="margin-left:8px">Answer!</button>
      </div>
    </section>

    <div class="grid">
      <section id="tab-shop" class="panel hidden">
        <h2>Shop — Generators</h2>
        <div class="buybar">
          <span class="muted">Buying:</span>
          <select id="buyMode">
            <option value="1">x1</option>
            <option value="10">x10</option>
            <option value="25">x25</option>
            <option value="100">x100</option>
            <option value="max">Max</option>
          </select>
          <span class="tag">Tip: Milestones at 25/50/100/150/200 double that building. Your Cap discount is applied automatically.</span>
        </div>
        <div id="shopList"></div>
      </section>

      <section id="tab-upgrades" class="panel hidden">
        <h2>Upgrades</h2>
        <div id="upgradeList" class="upgradelist"></div>
      </section>
    </div>

    <!-- ===== PRESTIGE ===== -->
    <section id="tab-prestige" class="panel hidden">
      <h2>Graduate (Prestige)</h2>
      <p>Graduating resets Knowledge, buildings, and upgrades, but you earn <strong>Caps</strong> 🎓 which give a permanent production boost. Each Cap increases all production by <strong>+3%</strong> (multiplicative). <em>Your +3% bonus now uses <strong>Total Caps</strong>, so spending in the Cap Shop won’t reduce it.</em></p>
      <div class="stack">
        <div class="pill"><small>Lifetime Knowledge</small><strong id="lifeK">0</strong></div>
        <div class="pill"><small>Caps on Graduate</small><strong id="capsNow">0</strong></div>
        <div class="pill"><small>Unspent Caps</small><strong id="capsUnspentPrestige">0</strong></div>
        <div class="pill"><small>Total Caps</small><strong id="capsTotalPrestige">0</strong></div>
        <div class="pill"><small>Global Multiplier</small><strong id="globalMult">x1.00</strong></div>
      </div>
      <div class="sep"></div>
      <button id="graduate" class="danger">🎓 Graduate now (prestige)</button>
      <p class="small muted">Formula: <code>floor( sqrt(lifetimeKnowledge / 10,000,000) )</code>. Push further for more Caps.</p>
    </section>

    <!-- ===== CAP SHOP ===== -->
    <section id="tab-capshop" class="panel hidden">
      <h2>Cap Shop — Permanent Upgrades</h2>
      <p class="small muted">Spend your <strong>unspent Caps</strong> here. Your +3%/Cap bonus is based on <em>Total Caps</em> (earned all‑time), so spending does not reduce it.</p>
      <div class="stack" style="margin-bottom:8px">
        <div class="pill"><small>Unspent Caps</small><strong id="capsUnspent">0</strong></div>
        <div class="pill"><small>Total Caps</small><strong id="capsTotal">0</strong></div>
      </div>
      <div id="capShopList" class="upgradelist"></div>
    </section>

    <section id="tab-achievements" class="panel hidden">
      <h2>Achievements <span class="muted small">(each gives +0.5% global)</span></h2>
      <div id="achList" class="achlist"></div>
    </section>

    <section id="tab-stats" class="panel hidden">
      <h2>Stats</h2>
      <div class="stack">
        <div class="pill"><small>Time played</small><strong id="timePlayed">0s</strong></div>
        <div class="pill"><small>Total clicks</small><strong id="totalClicks">0</strong></div>
        <div class="pill"><small>Total built</small><strong id="totalBuilt">0</strong></div>
        <div class="pill"><small>Save file size</small><strong id="saveSize">0 KB</strong></div>
      </div>
      <div class="sep"></div>
      <div id="statLines" class="small muted"></div>
    </section>

    <section id="tab-settings" class="panel hidden">
      <h2>Settings</h2>
      <div class="stack" style="margin-bottom:8px">
        <label class="tag">Notation:
          <select id="notation">
            <option value="short">Short (K, M, B)</option>
            <option value="sci">Scientific</option>
            <option value="full">Full</option>
          </select>
        </label>
        <label class="tag"><input type="checkbox" id="mute"> Mute sounds</label>
        <label class="tag"><input type="checkbox" id="particles" checked> Click particles</label>
      </div>
      <div class="stack">
        <button id="export">⬇️ Export save</button>
        <button id="import">⬆️ Import save</button>
        <button id="hardReset" class="danger">♻️ Hard reset</button>
      </div>
      <textarea id="io" placeholder="Exported save will appear here…" style="width:100%; margin-top:10px; height:110px"></textarea>
    </section>

    <section id="tab-help" class="panel hidden">
      <h2>Help</h2>
      <ul>
        <li>Click the <strong>Study Orb</strong> to earn Knowledge; steady rhythm builds <strong>combo</strong> (now upgradeable in the Cap Shop).</li>
        <li>Buy generators in the <strong>Shop</strong>. Hitting <strong>25/50/100/150/200</strong> of a building doubles that building’s output.</li>
        <li><strong>Upgrades</strong> make clicks and generators stronger. Some unlock when you own enough of a building.</li>
        <li>Occasionally a <strong>Pop Quiz</strong> appears. Click it for an instant payout and a temporary production boost.</li>
        <li>When progress slows, <strong>Graduate</strong> to earn <strong>Caps</strong>. Then spend them in the <strong>Cap Shop</strong> for permanent boosts.</li>
      </ul>
    </section>

    <div class="footer">
      Built for you to pass time responsibly. Remember: real studying > fake studying 😉
    </div>
  </div>

  <div id="toast" class="toast hidden"></div>

<script>
(() => {
'use strict';

const VERSION = '1.4.0'; // new features: Cap Shop, redesigned clicker, campus scene, cap progress

// ---------- Utilities ----------
const clamp = (v, min, max) => Math.min(max, Math.max(min, v));
const now = () => Date.now();
const fmtTime = (ms) => {
  let s = Math.floor(ms/1000);
  const d = Math.floor(s/86400); s -= d*86400;
  const h = Math.floor(s/3600); s -= h*3600;
  const m = Math.floor(s/60); s -= m*60;
  const parts = [];
  if (d) parts.push(d+'d');
  if (h || parts.length) parts.push(h+'h');
  if (m || parts.length) parts.push(m+'m');
  parts.push(s+'s');
  return parts.join(' ');
};
const SUFFIX = ["","K","M","B","T","Qa","Qi","Sx","Sp","Oc","No","Dc","Ud","Dd","Td","Qad","Qid","Sxd","Spd","Ocd","Nod"];
function formatNumber(n, notation='short'){
  if (!isFinite(n)) return '∞';
  if (notation==='full'){
    return n.toLocaleString(undefined,{maximumFractionDigits:2});
  }
  if (notation==='sci'){
    if (n===0) return '0';
    const e = Math.floor(Math.log10(Math.abs(n)));
    const m = n / Math.pow(10, e);
    return m.toFixed(2)+'e'+e;
  }
  const abs = Math.abs(n);
  if (abs < 1000) return n.toLocaleString(undefined,{maximumFractionDigits:2});
  let tier = Math.floor(Math.log10(abs)/3);
  tier = Math.min(tier, SUFFIX.length-1);
  const scaled = n / Math.pow(10, tier*3);
  return scaled.toFixed(2).replace(/\.00$/,'') + ' ' + SUFFIX[tier];
}
function geometricCost(baseCost, mult, owned, n){
  return baseCost * Math.pow(mult, owned) * ((Math.pow(mult, n)-1)/(mult-1));
}
function maxAffordableN(k, baseCost, mult, owned){
  if (k < baseCost * Math.pow(mult, owned)) return 0;
  const a = baseCost * Math.pow(mult, owned);
  const rhs = (k*(mult-1)/a)+1;
  const n = Math.floor(Math.log(rhs)/Math.log(mult));
  return Math.max(0, n);
}
function toast(msg, cls=''){
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast ' + (cls||'');
  t.classList.remove('hidden');
  setTimeout(()=>t.classList.add('hidden'), 2600);
}
const $ = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);

// ---------- Game Data ----------
const BUILDINGS = [
  {id:'notebook', name:'Notebook', icon:'📒', desc:'Jot down thoughts. Slow but steady.', baseCost: 15, costMult:1.15, baseProd:0.10},
  {id:'buddy', name:'Study Buddy', icon:'👥', desc:'Quiz each other to stay sharp.', baseCost: 120, costMult:1.17, baseProd:1.2},
  {id:'tutor', name:'Tutor', icon:'🧑‍🏫', desc:'Explains everything twice.', baseCost: 1100, costMult:1.17, baseProd:8},
  {id:'club', name:'Study Club', icon:'📚', desc:'A circle of overachievers.', baseCost: 12000, costMult:1.18, baseProd:47},
  {id:'lab', name:'Science Lab', icon:'⚗️', desc:'Smelly room, big ideas.', baseCost: 130000, costMult:1.19, baseProd:260},
  {id:'library', name:'Library Wing', icon:'🏛️', desc:'Shhh. Productive hum.', baseCost: 1400000, costMult:1.20, baseProd:1400},
  {id:'campus', name:'Mini Campus', icon:'🎓', desc:'Make your own quad.', baseCost: 20000000, costMult:1.20, baseProd:7800},
  {id:'ai', name:'AI Researcher', icon:'🤖', desc:'Never procrastinates.', baseCost: 330000000, costMult:1.21, baseProd:44000},
  {id:'sat', name:'EduSat', icon:'🛰️', desc:'Lessons from orbit.', baseCost: 5100000000, costMult:1.22, baseProd:260000},
  {id:'meta', name:'Meta Class', icon:'🌀', desc:'Simulated classrooms.', baseCost: 75000000000, costMult:1.23, baseProd:1800000},
];
const MILESTONES = [25,50,100,150,200]; // each milestone doubles building

// Regular upgrades
const UPGRADE_DEFS = [
  // Click upgrades
  {id:'click1', name:'Ergonomic Pen', desc:'+100% click value.', cost:250, type:'click', mult:2, req:s=>true},
  {id:'click2', name:'Fountain Pen', desc:'+200% click value.', cost:5000, type:'click', mult:3, req:s=>s.upgrades.has('click1')},
  {id:'click3', name:'Mechanical Keyboard', desc:'+300% click value.', cost:65000, type:'click', mult:4, req:s=>s.upgrades.has('click2')},
  {id:'click4', name:'Dual Monitors', desc:'+500% click value.', cost:750000, type:'click', mult:6, req:s=>s.upgrades.has('click3')},

  // Global upgrades
  {id:'glob1', name:'Time Blocking', desc:'All production +25%.', cost:15000, type:'global', mult:1.25, req:s=>s.totalOwned>=20},
  {id:'glob2', name:'Pomodoro Mastery', desc:'All production +50%.', cost:250000, type:'global', mult:1.5, req:s=>s.totalOwned>=60},
  {id:'glob3', name:'Deep Work', desc:'All production +75%.', cost:4500000, type:'global', mult:1.75, req:s=>s.totalOwned>=120},
  {id:'glob4', name:'Flow State', desc:'All production +100%.', cost:90000000, type:'global', mult:2.0, req:s=>s.totalOwned>=220},

  // Per-building (two tiers each; unlock at ownership 10/50)
  ...BUILDINGS.flatMap(b => ([
    {id:`${b.id}u1`, name:`${b.name} Methods`, desc:`${b.name} output x2.`, cost: Math.floor(b.baseCost*8), type:'building', target:b.id, mult:2, req:s=>s.buildings[b.id].count>=10},
    {id:`${b.id}u2`, name:`Advanced ${b.name}`, desc:`${b.name} output x2.`, cost: Math.floor(b.baseCost*32), type:'building', target:b.id, mult:2, req:s=>s.buildings[b.id].count>=50},
  ])),
];

// ===== Cap Shop: permanent upgrades (cost in unspent Caps, effect persists) =====
const CAP_UPGRADES = [
  {
    id:'endowment',
    name:'Scholarly Endowment',
    desc:s=>`All production +10% per level (multiplicative). Current: x${capEndowmentMult(s).toFixed(2)}`,
    nextCost:s=>Math.ceil(5 * Math.pow(1.8, s.capUpgrades.endowment||0)),
    buy:s=>{ s.capUpgrades.endowment = (s.capUpgrades.endowment||0)+1; }
  },
  {
    id:'efficiency',
    name:'Tuition Grant',
    desc:s=>{
      const d = (1 - priceMult(s))*100;
      return `All building prices reduced ~1.5%/level (multiplicative). Current: -${d.toFixed(1)}%`;
    },
    nextCost:s=>Math.ceil(3 * Math.pow(1.7, s.capUpgrades.efficiency||0)),
    buy:s=>{ s.capUpgrades.efficiency = (s.capUpgrades.efficiency||0)+1; }
  },
  {
    id:'click',
    name:'Study Focus',
    desc:s=>`Click value +25% per level (multiplicative). Current: x${clickCapShopMult(s).toFixed(2)}`,
    nextCost:s=>Math.ceil(4 * Math.pow(1.75, s.capUpgrades.click||0)),
    buy:s=>{ s.capUpgrades.click = (s.capUpgrades.click||0)+1; }
  },
  {
    id:'quiz',
    name:'Quiz Bowl',
    desc:s=>{
      const lvl = s.capUpgrades.quiz||0;
      return `Pop Quiz stronger & longer: instant +${(15*lvl)}%, buff x${(1+0.1*lvl).toFixed(2)} for ${30+5*lvl}s.`;
    },
    nextCost:s=>Math.ceil(6 * Math.pow(1.6, s.capUpgrades.quiz||0)),
    buy:s=>{ s.capUpgrades.quiz = (s.capUpgrades.quiz||0)+1; }
  },
  {
    id:'combo',
    name:'Combo Theory',
    desc:s=>{
      const lvl = s.capUpgrades.combo||0;
      return `Max combo +5 and window +100ms per level. Current: max x${(1 + (50+5*lvl)*0.01).toFixed(2)} cap, window ${(1000+100*lvl)}ms.`;
    },
    nextCost:s=>Math.ceil(3 * Math.pow(1.5, s.capUpgrades.combo||0)),
    buy:s=>{ s.capUpgrades.combo = (s.capUpgrades.combo||0)+1; }
  },
  {
    id:'offline',
    name:'Night School',
    desc:s=>{
      const h = 12 + 2*(s.capUpgrades.offline||0);
      return `Offline progress cap +2h per level (base 12h). Current cap: ${h}h (max 48h).`;
    },
    nextCost:s=>Math.ceil(2 * Math.pow(1.5, s.capUpgrades.offline||0)),
    buy:s=>{ s.capUpgrades.offline = (s.capUpgrades.offline||0)+1; }
  },
];

// Achievements (two cap-related ones now use Total Caps)
const ACH_DEFS = [
  {id:'k1', name:'Warm‑up', desc:'Reach 1,000 Knowledge.', cond:s=>s.lifetimeKnowledge>=1e3},
  {id:'k2', name:'Study Session', desc:'Reach 1,000,000 Knowledge.', cond:s=>s.lifetimeKnowledge>=1e6},
  {id:'k3', name:'All‑nighter', desc:'Reach 1,000,000,000 Knowledge.', cond:s=>s.lifetimeKnowledge>=1e9},
  {id:'k4', name:'Dean’s List', desc:'Reach 1e12 Knowledge.', cond:s=>s.lifetimeKnowledge>=1e12},
  {id:'c1', name:'Clicker', desc:'Click 100 times.', cond:s=>s.clicks>=100},
  {id:'c2', name:'Carpal Tunnel', desc:'Click 2,000 times.', cond:s=>s.clicks>=2000},
  {id:'b1', name:'First Steps', desc:'Own 10 total buildings.', cond:s=>s.totalOwned>=10},
  {id:'b2', name:'Growing Campus', desc:'Own 100 total buildings.', cond:s=>s.totalOwned>=100},
  {id:'b3', name:'Institution', desc:'Own 500 total buildings.', cond:s=>s.totalOwned>=500},
  {id:'m1', name:'Milestone Maker', desc:'Hit any 25 milestone.', cond:s=>s.milestonesUnlocked>0},
  {id:'p1', name:'Graduate', desc:'Prestige once.', cond:s=>s.prestiges>=1},
  {id:'p2', name:'Valedictorian', desc:'Earn 50 Total Caps.', cond:s=>s.capsTotal>=50},
  {id:'g1', name:'Finish Line (soft)', desc:'Earn 250 Total Caps.', cond:s=>s.capsTotal>=250},
];

// ---------- State ----------
const defaultState = () => ({
  version: VERSION,
  knowledge: 0,
  lifetimeKnowledge: 0,
  caps: 0,           // unspent
  capsTotal: 0,      // earned all-time (drives +3%/Cap)
  buildings: Object.fromEntries(BUILDINGS.map(b => [b.id,{count:0}])),

  // multipliers
  globalMult: 1, // from regular upgrades
  clickMult: 1,  // from regular upgrades
  perBuildingMult: Object.fromEntries(BUILDINGS.map(b => [b.id,1])),
  milestoneMult: Object.fromEntries(BUILDINGS.map(b => [b.id,1])),

  upgrades: new Set(),
  achievements: new Set(),

  clicks: 0,
  totalOwned: 0,
  milestonesUnlocked: 0,
  prestiges: 0,

  // runtime
  clickCombo: 0,
  comboExpireAt: 0,
  activeEvent: null, // {endsAt, expiresAt}
  focusMult: 1,

  // Cap Shop
  capUpgrades: { endowment:0, efficiency:0, click:0, quiz:0, combo:0, offline:0 },

  // options
  notation:'short',
  muted: true,
  particles: true,

  startedAt: now(),
  lastTick: now(),
  lastSave: now(),
});

let state = defaultState();

// ---------- Persistence ----------
const SAVE_KEY = 'study-saga-save-v2';
function save(){
  try{
    const obj = {
      ...state,
      upgrades:[...state.upgrades],
      achievements:[...state.achievements],
    };
    const json = JSON.stringify(obj);
    localStorage.setItem(SAVE_KEY, json);
    state.lastSave = now();
    document.getElementById('saveSize').textContent = (json.length/1024).toFixed(1)+' KB';
    toast('Game saved 💾');
  }catch(e){ console.error(e); toast('Save failed', 'danger'); }
}
function load(){
  const raw = localStorage.getItem(SAVE_KEY);
  if (!raw) return;
  try{
    const obj = JSON.parse(raw);
    state = Object.assign(defaultState(), obj);
    state.upgrades = new Set(obj.upgrades||[]);
    state.achievements = new Set(obj.achievements||[]);
    // Back-compat: if capsTotal missing, set to current caps
    if (typeof state.capsTotal !== 'number') state.capsTotal = state.caps||0;
    if (!state.capUpgrades) state.capUpgrades = { endowment:0, efficiency:0, click:0, quiz:0, combo:0, offline:0 };
  }catch(e){ console.error(e); }
}

// ---------- Cap Shop math helpers ----------
function capMultiplier(s=state){ return Math.pow(1.03, s.capsTotal); }               // +3% per Total Cap
function capEndowmentMult(s=state){ return Math.pow(1.10, (s.capUpgrades.endowment||0)); }
function priceMult(s=state){ return Math.pow(0.985, (s.capUpgrades.efficiency||0)); } // building prices
function clickCapShopMult(s=state){ return Math.pow(1.25, (s.capUpgrades.click||0)); }
function comboMax(s=state){ return 50 + 5*(s.capUpgrades.combo||0); }
function comboWindowMs(s=state){ return 1000 + 100*(s.capUpgrades.combo||0); }
function offlineCapSeconds(s=state){ return Math.min(48, 12 + 2*(s.capUpgrades.offline||0)) * 3600; }
function quizInstantMult(s=state){ return 1 + 0.15*(s.capUpgrades.quiz||0); }
function quizBuffMult(s=state){ return 2 * (1 + 0.10*(s.capUpgrades.quiz||0)); }
function quizBuffMs(s=state){ return 30000 + 5000*(s.capUpgrades.quiz||0); }

// ---------- Core math ----------
function achievementMultiplier(){ return 1 + (state.achievements.size * 0.005); }
function milestonesFor(id, count){
  let mult = 1;
  MILESTONES.forEach(m => { if (count>=m) mult*=2; });
  return mult;
}
function recomputeMilestones(){
  let m = 0;
  BUILDINGS.forEach(b=>{
    const c = state.buildings[b.id].count;
    const mult = milestonesFor(b.id, c);
    const prev = state.milestoneMult[b.id] || 1;
    state.milestoneMult[b.id] = mult;
    const unlocked = Math.log2(mult);
    m += unlocked;
    if (mult>prev) toast(`${b.name} milestone! Output doubled.`, 'good');
  });
  state.milestonesUnlocked = m;
}
function totalKps(){
  const base = BUILDINGS.reduce((sum, b)=>{
    const c = state.buildings[b.id].count;
    const mult = state.perBuildingMult[b.id] * state.milestoneMult[b.id];
    return sum + c * b.baseProd * mult;
  }, 0);
  const global = state.globalMult * capMultiplier() * capEndowmentMult() * achievementMultiplier() * state.focusMult;
  return base * global;
}
function clickValue(){
  const base = 1 * state.clickMult * clickCapShopMult();
  const comboMult = 1 + Math.min(comboMax(), state.clickCombo) * 0.01;
  return (base + totalKps()*0.20) * capMultiplier() * capEndowmentMult() * achievementMultiplier() * state.focusMult * comboMult;
}
function capsForPrestige(){
  return Math.floor(Math.sqrt(state.lifetimeKnowledge / 1e7));
}
function capProgressInfo(){
  const c = Math.floor(Math.sqrt(state.lifetimeKnowledge / 1e7));
  const prev = 1e7 * c*c;
  const next = 1e7 * (c+1)*(c+1);
  const need = Math.max(0, next - state.lifetimeKnowledge);
  const frac = next>prev ? (state.lifetimeKnowledge - prev) / (next - prev) : 0;
  return {current:c, prev, next, need, frac: clamp(frac,0,1)};
}

// ---------- Events ----------
function maybeSpawnEvent(dtMs){
  if (state.activeEvent || dtMs < 1000) return;
  const chancePerSecond = 1/90;
  if (Math.random() < chancePerSecond){
    const expiresAt = now() + 15000;
    state.activeEvent = {expiresAt, endsAt: 0};
    renderEvent();
  }
}
function clickEvent(){
  if (!state.activeEvent) return;
  if (now() > state.activeEvent.expiresAt) return;
  const instant = totalKps()*60*quizInstantMult();
  state.knowledge += instant;
  state.lifetimeKnowledge += instant;
  state.focusMult = quizBuffMult();
  state.activeEvent.endsAt = now() + quizBuffMs();
  toast(`Pop Quiz! +${fmt(instant)} Knowledge and Focus x${(quizBuffMult()).toFixed(2)} for ${Math.round(quizBuffMs()/1000)}s.`, 'good');
  renderEvent();
}
function tickEvent(){
  if (!state.activeEvent) return;
  const t = now();
  if (state.activeEvent.expiresAt && t > state.activeEvent.expiresAt && state.activeEvent.endsAt===0){
    state.activeEvent = null; renderEvent(); return;
  }
  if (state.activeEvent.endsAt && t > state.activeEvent.endsAt){
    state.focusMult = 1;
    state.activeEvent = null; renderEvent(); return;
  }
  renderEvent();
}
function renderEvent(){
  const area = document.getElementById('eventArea');
  if (!state.activeEvent){ area.classList.remove('show'); return; }
  area.classList.add('show');
  const t = document.getElementById('eventTime');
  const left = (state.activeEvent.endsAt ? state.activeEvent.endsAt : state.activeEvent.expiresAt) - now();
  t.textContent = Math.max(0, Math.ceil(left/1000));
}

// ---------- UI rendering ----------
function fmt(n){ return formatNumber(n, state.notation); }

function renderHeader(){
  $('#knowledge').textContent = fmt(state.knowledge);
  $('#kps').textContent = fmt(totalKps());
  $('#caps').textContent = fmt(state.caps); // unspent
  $('#combo').textContent = 'x' + (1 + Math.min(comboMax(),state.clickCombo)*0.01).toFixed(2);
  const pv = clickValue();
  const prevEl = $('#clickPreview'); if (prevEl) prevEl.textContent = fmt(pv);
}

function renderCampusScene(){
  const wrap = $('#campusScene');
  if (!wrap) return;

  // Always hard reset the scene each render
  wrap.textContent = '';

  BUILDINGS.forEach((b, i)=>{
    const c = state.buildings[b.id]?.count || 0;
    if (c <= 0) return;

    // One tile per building type, with a count badge.
    const el = document.createElement('div');
    el.className = 'tile';
    el.style.animationDelay = ((i * 0.15) % 2).toFixed(2) + 's';
    el.innerHTML = `<div class="ic" title="${b.name}">${b.icon}</div>
                    <div class="badge">x${c}</div>`;
    wrap.appendChild(el);
  });

  if (!wrap.children.length){
    const hint = document.createElement('div');
    hint.className = 'muted small';
    hint.textContent = 'Buy something in the Shop to populate your campus.';
    wrap.appendChild(hint);
  }
}


function renderCapProgress(){
  const info = capProgressInfo();
  const bar = $('#capProgBar'); if (bar) bar.style.width = (info.frac*100).toFixed(1)+'%';
  $('#capProgLeft').textContent = `Next Cap (${info.current+1}) at ${fmt(info.next)} lifetime — need ${fmt(info.need)} more`;
  $('#capProgGain').textContent = `Caps on Graduate now: ${fmt(capsForPrestige())}`;
}

function renderShop(){
  const buyMode = $('#buyMode').value;
  const list = $('#shopList');
  list.innerHTML = '';
  BUILDINGS.forEach(b=>{
    const s = state.buildings[b.id];
    const owned = s.count;
    const baseAdj = b.baseCost * priceMult();
    const buyN = buyMode==='max' ? maxAffordableN(state.knowledge, baseAdj, b.costMult, owned)
                 : parseInt(buyMode,10);
    const cost = buyN ? geometricCost(baseAdj,b.costMult,owned,buyN) : baseAdj*Math.pow(b.costMult,owned);
    const can = state.knowledge >= cost && buyN>0;
    const item = document.createElement('div');
    item.className = 'shopitem';
    item.innerHTML = `
      <div class="icon">${b.icon}</div>
      <div>
        <h4>${b.name} <span class="muted">owned:</span> <strong>${owned}</strong></h4>
        <div class="desc">${b.desc}</div>
        <div class="small muted">Output: <strong>${fmt(b.baseProd * state.perBuildingMult[b.id] * state.milestoneMult[b.id])}</strong> /s each</div>
        <div class="small muted">Milestone mult: x${state.milestoneMult[b.id].toFixed(0)}</div>
      </div>
      <div style="text-align:right">
        <div class="price ${can?'afford':'cant'}">${buyMode==='max'?'Buy max':'Buy x'+buyN}: ${fmt(cost)}</div>
        <button ${can?'':'disabled'} data-buy="${b.id}">${can ? 'Purchase' : 'Need ' + fmt(cost)}</button>
        <div class="small muted">Cap discount: -${((1-priceMult())*100).toFixed(1)}%</div>
      </div>`;
    list.appendChild(item);
  });
  list.querySelectorAll('button[data-buy]').forEach(btn=>{
    btn.onclick = () => buyBuilding(btn.getAttribute('data-buy'), $('#buyMode').value);
  });
}

function renderUpgrades(){
  const wrap = $('#upgradeList');
  wrap.innerHTML = '';
  const available = UPGRADE_DEFS.filter(u => u.req(state) && !state.upgrades.has(u.id));
  if (available.length===0) {
    wrap.innerHTML = `<div class="card"><h4>No upgrades available (yet)</h4><div class="meta">Own more buildings or earn more Knowledge.</div></div>`;
    return;
  }
  available.forEach(u=>{
    const can = state.knowledge >= u.cost;
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <h4>${u.name}</h4>
      <div class="meta">${u.desc}</div>
      <div class="sep"></div>
      <div class="row">
        <div class="price ${can?'afford':'cant'}">Cost: ${fmt(u.cost)}</div>
        <button ${can?'':'disabled'} data-up="${u.id}">Buy</button>
      </div>`;
    wrap.appendChild(card);
  });
  wrap.querySelectorAll('button[data-up]').forEach(btn=>{
    btn.onclick = () => buyUpgrade(btn.getAttribute('data-up'));
  });
}

function renderPrestige(){
  $('#lifeK').textContent = fmt(state.lifetimeKnowledge);
  $('#capsNow').textContent = fmt(capsForPrestige());
  $('#capsUnspentPrestige').textContent = fmt(state.caps);
  $('#capsTotalPrestige').textContent = fmt(state.capsTotal);
  const mult = capMultiplier() * capEndowmentMult() * achievementMultiplier();
  $('#globalMult').textContent = 'x' + mult.toFixed(2);
}

function renderAchievements(){
  const wrap = $('#achList');
  wrap.innerHTML = '';
  ACH_DEFS.forEach(a=>{
    const achieved = state.achievements.has(a.id);
    const card = document.createElement('div');
    card.className = 'card ' + (achieved ? 'good' : '');
    card.innerHTML = `<h4>${achieved ? '🏆 ' : ''}${a.name}</h4>
      <div class="meta">${a.desc}</div>
      <div class="small muted">${achieved ? '+0.5% global (counted)' : 'Locked'}</div>`;
    wrap.appendChild(card);
  });
}

function renderStats(){
  $('#timePlayed').textContent = fmtTime(now() - state.startedAt);
  $('#totalClicks').textContent = state.clicks.toLocaleString();
  $('#totalBuilt').textContent = state.totalOwned.toLocaleString();
  const lines = [
    `KPS (raw): ${totalKps().toFixed(2)}`,
    `Global Multiplier (regular upgrades): x${state.globalMult.toFixed(2)}`,
    `Cap Endowment Multiplier: x${capEndowmentMult().toFixed(2)} (Cap Shop)`,
    `Caps Multiplier (+3%/Total Cap): x${capMultiplier().toFixed(2)} (Total Caps ${state.capsTotal})`,
    `Achievement Multiplier: x${achievementMultiplier().toFixed(3)} (${state.achievements.size} achievements)`,
    `Click Multiplier (regular): x${state.clickMult.toFixed(2)}; Cap Shop click: x${clickCapShopMult().toFixed(2)}`,
    `Focus (temporary): x${state.focusMult.toFixed(2)}`,
    `Building Price Discount: -${((1-priceMult())*100).toFixed(1)}%`,
    `Combo window: ${comboWindowMs()}ms, max combo cap: ${comboMax()}`,
  ];
  $('#statLines').innerHTML = lines.map(l=>`<div>• ${l}</div>`).join('');
}

function renderCapShop(){
  $('#capsUnspent').textContent = fmt(state.caps);
  $('#capsTotal').textContent = fmt(state.capsTotal);
  const wrap = $('#capShopList');
  wrap.innerHTML = '';
  CAP_UPGRADES.forEach(u=>{
    const lvl = state.capUpgrades[u.id]||0;
    const cost = u.nextCost(state);
    const can = state.caps >= cost;
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <h4>${u.name} <span class="muted">(lvl ${lvl})</span></h4>
      <div class="meta">${u.desc(state)}</div>
      <div class="sep"></div>
      <div class="row">
        <div class="price ${can?'afford':'cant'}">Cost: ${cost} Caps</div>
        <button ${can?'':'disabled'} data-cap="${u.id}">Buy</button>
      </div>`;
    wrap.appendChild(card);
  });
  wrap.querySelectorAll('button[data-cap]').forEach(btn=>{
    btn.onclick = ()=> buyCapUpgrade(btn.getAttribute('data-cap'));
  });
}

function renderAll(){
  renderHeader();
  renderShop();
  renderUpgrades();
  renderPrestige();
  renderAchievements();
  renderStats();
  renderCapShop();
  renderCampusScene();
  renderCapProgress();
}

// ---------- Actions ----------
function buyBuilding(id, mode){
  const b = BUILDINGS.find(x=>x.id===id);
  const owned = state.buildings[id].count;
  const baseAdj = b.baseCost * priceMult();
  const n = mode==='max' ? maxAffordableN(state.knowledge, baseAdj, b.costMult, owned) : parseInt(mode,10);
  if (n<=0) return;
  const cost = geometricCost(baseAdj,b.costMult,owned,n);
  if (state.knowledge < cost) return;
  state.knowledge -= cost;
  state.buildings[id].count += n;
  state.totalOwned += n;
  recomputeMilestones();
  renderAll();
}
function buyUpgrade(id){
  const u = UPGRADE_DEFS.find(x=>x.id===id);
  if (!u || state.upgrades.has(id) || state.knowledge < u.cost) return;
  state.knowledge -= u.cost;
  state.upgrades.add(id);
  if (u.type==='click')      state.clickMult *= u.mult;
  else if (u.type==='global') state.globalMult *= u.mult;
  else if (u.type==='building') state.perBuildingMult[u.target] *= u.mult;
  toast(`Purchased: ${u.name} ✔`);
  renderAll();
}
function buyCapUpgrade(id){
  const u = CAP_UPGRADES.find(x=>x.id===id);
  if (!u) return;
  const cost = u.nextCost(state);
  if (state.caps < cost) return;
  state.caps -= cost;
  u.buy(state);
  toast(`Cap Shop: ${u.name} upgraded ✔`, 'good');
  renderAll();
}
function graduate(){
  const capsGain = capsForPrestige();
  if (capsGain<=0){
    toast('Not enough lifetime Knowledge to earn Caps yet.', 'warn'); return;
  }
  if (!confirm(`Graduate now for ${capsGain} Caps? This resets your Knowledge, buildings, and upgrades.`)) return;

  const keep = {
    caps: state.caps + capsGain,
    capsTotal: state.capsTotal + capsGain,
    achievements:new Set(state.achievements),
    capUpgrades: {...state.capUpgrades},
    startedAt: state.startedAt,
    lifetimeKnowledge: state.lifetimeKnowledge
  };
  state = defaultState();
  state.caps = keep.caps;
  state.capsTotal = keep.capsTotal;
  state.achievements = keep.achievements;
  state.capUpgrades = keep.capUpgrades;
  state.startedAt = keep.startedAt;
  state.lifetimeKnowledge = keep.lifetimeKnowledge;
  state.prestiges = (state.prestiges||0)+1;
  toast(`Graduated! +${capsGain} Caps. 🎓`, 'good');
  renderAll();
}

// ---------- Main loop ----------
function gameTick(){
  const t = now();
  const dt = t - state.lastTick;
  state.lastTick = t;

  // gain knowledge from buildings
  const kps = totalKps();
  const gain = kps * (dt/1000);
  state.knowledge += gain;
  state.lifetimeKnowledge += gain;

  // combo timeout
  if (state.comboExpireAt && t > state.comboExpireAt){
    state.clickCombo = 0;
    state.comboExpireAt = 0;
  }

  // events
  maybeSpawnEvent(dt);
  tickEvent();

  // autosave ~30s
  if (t - state.lastSave > 30000) save();

  renderHeader();
  renderCapProgress();
}
function resumeOffline(){
  const t = now();
  const diff = t - state.lastTick;
  if (diff>15000){
    const kps = totalKps();
    const seconds = Math.min(diff/1000, offlineCapSeconds());
    const gain = kps * seconds;
    state.knowledge += gain;
    state.lifetimeKnowledge += gain;
    toast(`While away: +${fmt(gain)} Knowledge over ${fmtTime(seconds*1000)}.`, 'good');
  }
  state.lastTick = t;
}

// ---------- Effects ----------
function spawnParticle(x,y){
  if (!state.particles) return;
  const p = document.createElement('div');
  p.textContent = '+' + fmt(clickValue());
  p.style.position='fixed';
  p.style.left = (x-10)+'px'; p.style.top=(y-10)+'px';
  p.style.pointerEvents='none';
  p.style.fontWeight='800';
  p.style.fontSize='12px';
  p.style.color='var(--accent)';
  p.style.opacity='1';
  p.style.transition='transform .6s ease, opacity .6s ease';
  document.body.appendChild(p);
  requestAnimationFrame(()=>{
    p.style.transform='translateY(-32px)';
    p.style.opacity='0';
  });
  setTimeout(()=>p.remove(),600);
}

// ---------- Events: DOM ----------
function bindUI(){
  // Tabs
  $$('.tabs button').forEach(btn=>{
    btn.onclick = () => {
      $$('.tabs button').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const t = btn.getAttribute('data-tab');
      ['main','shop','upgrades','prestige','capshop','achievements','stats','settings','help'].forEach(id=>{
        const el = document.getElementById('tab-'+id);
        if (!el) return;
        el.classList.toggle('hidden', id!==t);
      });
      renderAll();
    };
  });

  // Clicker (Study Orb)
  $('#clicker').addEventListener('click', (e)=>{
    const val = clickValue();
    state.knowledge += val;
    state.lifetimeKnowledge += val;
    state.clicks++;
    // combo
    const t = now();
    if (t < state.comboExpireAt) state.clickCombo = Math.min(comboMax(), state.clickCombo+1);
    else state.clickCombo = 1;
    state.comboExpireAt = t + comboWindowMs();
    spawnParticle(e.clientX, e.clientY);
    renderHeader();
  });

  // Shop controls
  $('#buyMode').onchange = renderShop;

  // Prestige
  $('#graduate').onclick = graduate;

  // Event button
  $('#eventBtn').onclick = clickEvent;

  // Settings
  $('#toggleTheme').onclick = () => {
    const cur = document.body.getAttribute('data-theme') || 'dark';
    const next = cur==='dark'?'light':'dark';
    document.body.setAttribute('data-theme', next);
  };
  $('#saveNow').onclick = save;
  $('#notation').onchange = (e)=>{ state.notation = e.target.value; renderAll(); };
  $('#mute').onchange = (e)=>{ state.muted = e.target.checked; };
  $('#particles').onchange = (e)=>{ state.particles = e.target.checked; };

  // Export/Import
  $('#export').onclick = ()=>{
    const obj = {
      ...state,
      upgrades:[...state.upgrades],
      achievements:[...state.achievements],
    };
    const text = btoa(unescape(encodeURIComponent(JSON.stringify(obj))));
    $('#io').value = text;
    toast('Save exported to the textbox.');
  };
  $('#import').onclick = ()=>{
    const text = $('#io').value.trim();
    if (!text) return;
    try{
      const obj = JSON.parse(decodeURIComponent(escape(atob(text))));
      state = Object.assign(defaultState(), obj);
      state.upgrades = new Set(obj.upgrades||[]);
      state.achievements = new Set(obj.achievements||[]);
      if (typeof state.capsTotal !== 'number') state.capsTotal = state.caps||0;
      if (!state.capUpgrades) state.capUpgrades = { endowment:0, efficiency:0, click:0, quiz:0, combo:0, offline:0 };
      toast('Save imported ✔ (autosaved).','good');
      save();
      recomputeMilestones();
      renderAll();
    }catch(e){
      console.error(e);
      toast('Import failed.','danger');
    }
  };
  $('#hardReset').onclick = ()=>{
    if (!confirm('Hard reset? This will wipe your save.')) return;
    localStorage.removeItem(SAVE_KEY);
    state = defaultState();
    renderAll();
    toast('Save wiped.');
  };

  // visibility change (offline progress)
  document.addEventListener('visibilitychange', ()=>{
    if (document.visibilityState==='visible'){ resumeOffline(); }
  });
}

// ---------- Achievements check ----------
function checkAchievements(){
  let any = false;
  ACH_DEFS.forEach(a=>{
    if (!state.achievements.has(a.id) && a.cond(state)){
      state.achievements.add(a.id);
      toast(`Achievement unlocked: ${a.name} 🏆`, 'good');
      any = true;
    }
  });
  if (any){ renderPrestige(); renderAchievements(); renderStats(); }
}

// ---------- Boot ----------
load();
resumeOffline();
recomputeMilestones();
bindUI();
renderAll();
setInterval(gameTick, 50);
setInterval(checkAchievements, 800);

// ---------- First-time nudge ----------
if (!localStorage.getItem(SAVE_KEY)){
  toast('Welcome! Click the Study Orb to earn Knowledge. Buy a Notebook for passive income.', 'good');
}

})(); // IIFE
</script>
</body>
</html>
